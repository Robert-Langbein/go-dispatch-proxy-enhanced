<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go Dispatch Proxy Enhanced - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar">
        <div class="nav-brand">
            <i class="fas fa-network-wired nav-icon"></i>
            <h1>Go Dispatch Proxy Enhanced</h1>
        </div>
        <div class="nav-controls">
            <div class="status-indicator {{if gt .SystemInfo.TotalLBs 0}}online{{else}}offline{{end}}">
                <i class="fas fa-circle status-dot"></i>
                <span>{{if gt .SystemInfo.TotalLBs 0}}Online{{else}}Offline{{end}}</span>
            </div>
            <button class="btn btn-outline" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
            <button class="btn btn-outline theme-toggle" onclick="toggleTheme()">
                <i class="fas fa-moon theme-icon"></i>
                <span class="theme-text">Dark</span>
            </button>
            <a href="/logout" class="btn btn-danger">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </div>
    </nav>

    <div class="container">
        <!-- System Overview Cards -->
        <div class="section">
            <h2><i class="fas fa-chart-line"></i> System Overview</h2>
            <div class="stats-grid">
                <div class="stat-card primary">
                    <div class="stat-icon">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">{{.SystemInfo.TotalLBs}}</div>
                        <div class="stat-label">Load Balancers</div>
                    </div>
                </div>
                <div class="stat-card success">
                    <div class="stat-icon">
                        <i class="fas fa-link"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">{{.TotalConnections}}</div>
                        <div class="stat-label">Total Connections</div>
                    </div>
                </div>
                <div class="stat-card info">
                    <div class="stat-icon">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">{{printf "%.1f%%" .OverallSuccessRate}}</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">{{.SystemInfo.Uptime}}</div>
                        <div class="stat-label">Uptime</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Load Balancers Section -->
        <div class="section">
            <h2><i class="fas fa-balance-scale-right"></i> Load Balancers</h2>
            <div class="lb-grid">
                {{range .LoadBalancers}}
                <div class="lb-card {{if .Enabled}}enabled{{else}}disabled{{end}}">
                    <div class="lb-header">
                        <div class="lb-title">
                            <i class="fas fa-server"></i>
                            <h3>LB {{.ID}}: {{.Address}}</h3>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" {{if .Enabled}}checked{{end}} 
                                   onchange="toggleLoadBalancer('{{.Address}}', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="lb-info">
                        <div class="info-row">
                            <i class="fas fa-ethernet"></i>
                            <span><strong>Interface:</strong> {{.Interface}}</span>
                        </div>
                        <div class="info-row">
                            <i class="fas fa-weight-hanging"></i>
                            <span><strong>Default Ratio:</strong> {{.DefaultRatio}}</span>
                        </div>
                        <div class="info-row">
                            <i class="fas fa-percentage"></i>
                            <span><strong>Success Rate:</strong> {{printf "%.1f%%" .SuccessRate}}</span>
                        </div>
                    </div>
                    
                    <div class="lb-stats">
                        <div class="stat-group">
                            <div class="stat-item total">
                                <i class="fas fa-list-ol"></i>
                                <span>{{.TotalConnections}}</span>
                                <small>Total</small>
                            </div>
                            <div class="stat-item success">
                                <i class="fas fa-check-circle"></i>
                                <span>{{.SuccessCount}}</span>
                                <small>Success</small>
                            </div>
                            <div class="stat-item error">
                                <i class="fas fa-times-circle"></i>
                                <span>{{.FailureCount}}</span>
                                <small>Failures</small>
                            </div>
                        </div>
                    </div>
                    
                    {{if .SourceIPRules}}
                    <div class="source-rules">
                        <h4><i class="fas fa-filter"></i> Source IP Rules ({{len .SourceIPRules}})</h4>
                        <div class="rules-list">
                            {{range $ip, $rule := .SourceIPRules}}
                            <div class="rule-item">
                                <div class="rule-info">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span class="source-ip">{{$ip}}</span>
                                    <span class="ratio">Ratio: {{$rule.ContentionRatio}}</span>
                                </div>
                                <button class="btn btn-small btn-danger" 
                                        onclick="removeRule('{{$.Address}}', '{{$ip}}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            {{end}}
                        </div>
                    </div>
                    {{end}}
                    
                    <div class="lb-actions">
                        <button class="btn btn-primary" 
                                onclick="showAddRuleModal('{{.Address}}')">
                            <i class="fas fa-plus"></i>
                            Add Source IP Rule
                        </button>
                    </div>
                </div>
                {{end}}
            </div>
        </div>

        <!-- Real-time Traffic Statistics -->
        <div class="section">
            <h2><i class="fas fa-tachometer-alt"></i> Real-time Traffic</h2>
            <div class="traffic-stats">
                <div class="traffic-grid">
                    <div class="traffic-card transfer">
                        <div class="traffic-icon">
                            <i class="fas fa-download"></i>
                        </div>
                        <div class="traffic-content">
                            <div class="traffic-value" id="bytesPerSecond">
                                {{formatBytes .TrafficStats.BytesPerSecond}}/s
                                <small class="speed-bits">0 bit/s</small>
                            </div>
                            <div class="traffic-label">Combined Rate</div>
                        </div>
                    </div>
                    <div class="traffic-card data">
                        <div class="traffic-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="traffic-content">
                            <div class="traffic-value" id="totalDataTransferred">{{formatBytes .TrafficStats.TotalDataTransferred}}</div>
                            <div class="traffic-label">Total Data</div>
                        </div>
                    </div>
                    <div class="traffic-card connections">
                        <div class="traffic-icon">
                            <i class="fas fa-plug"></i>
                        </div>
                        <div class="traffic-content">
                            <div class="traffic-value" id="activeConnections">{{.TrafficStats.ActiveConnections}}</div>
                            <div class="traffic-label">Active Connections</div>
                        </div>
                    </div>
                    <div class="traffic-card rate">
                        <div class="traffic-icon">
                            <i class="fas fa-stopwatch"></i>
                        </div>
                        <div class="traffic-content">
                            <div class="traffic-value" id="connectionsPerMinute">{{.TrafficStats.ConnectionsPerMinute}}</div>
                            <div class="traffic-label">Connections/min</div>
                        </div>
                    </div>
                    <div class="traffic-card download">
                        <div class="traffic-icon">
                            <i class="fas fa-download"></i>
                        </div>
                        <div class="traffic-content">
                            <div class="traffic-value" id="bytesInPerSecond">
                                {{formatBytes .TrafficStats.BytesInPerSecond}}/s
                                <small class="speed-bits">0 bit/s</small>
                            </div>
                            <div class="traffic-label">Download Speed</div>
                        </div>
                    </div>
                    <div class="traffic-card upload">
                        <div class="traffic-icon">
                            <i class="fas fa-upload"></i>
                        </div>
                        <div class="traffic-content">
                            <div class="traffic-value" id="bytesOutPerSecond">
                                {{formatBytes .TrafficStats.BytesOutPerSecond}}/s
                                <small class="speed-bits">0 bit/s</small>
                            </div>
                            <div class="traffic-label">Upload Speed</div>
                        </div>
                    </div>
                </div>
                
                <!-- Real-time Traffic Chart -->
                <div class="traffic-chart-section">
                    <h3><i class="fas fa-chart-line"></i> Real-time Traffic Chart (Last 30 seconds)</h3>
                    <div class="chart-container">
                        <canvas id="trafficChart" width="800" height="300"></canvas>
                    </div>
                </div>
                
                <!-- Traffic Distribution -->
                <div class="traffic-distribution">
                    <h3><i class="fas fa-chart-bar"></i> Load Balancer Traffic Distribution</h3>
                    <div class="distribution-bars">
                        {{range $index, $lb := .LoadBalancers}}
                        <div class="lb-traffic-bar">
                            <div class="lb-traffic-info">
                                <div class="lb-traffic-label">
                                    <i class="fas fa-server"></i>
                                    LB{{add $index 1}}: {{$lb.Address}}
                                </div>
                                <div class="lb-traffic-stats">
                                    {{$lb.TotalConnections}} connections ({{printf "%.1f%%" (percentage $lb.TotalConnections $.TotalConnections)}})
                                </div>
                            </div>
                            <div class="traffic-bar-container">
                                <div class="traffic-bar" data-lb="{{$index}}" style="width: {{percentage $lb.TotalConnections $.TotalConnections}}%">
                                    <div class="traffic-bar-fill"></div>
                                </div>
                            </div>
                        </div>
                        {{end}}
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Connections -->
        <div class="section">
            <h2><i class="fas fa-network-wired"></i> Active Connections</h2>
            
            <div class="connections-controls">
                <div class="filter-group">
                    <div class="filter-item">
                        <i class="fas fa-search"></i>
                        <input type="text" id="sourceFilter" placeholder="Filter by source IP..." onkeyup="filterConnections()">
                    </div>
                    <div class="filter-item">
                        <i class="fas fa-search"></i>
                        <input type="text" id="destFilter" placeholder="Filter by destination..." onkeyup="filterConnections()">
                    </div>
                </div>
                <div class="control-group">
                    <button class="btn btn-primary" onclick="refreshConnections()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                    <div class="connection-count">
                        <i class="fas fa-list"></i>
                        Showing: <span id="connectionCount">{{len .ActiveConnections}}</span> connections
                    </div>
                </div>
            </div>
            
            <div class="connections-table" id="connectionsTable">
                {{if .ActiveConnections}}
                <table class="unifi-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-map-marker-alt"></i> Source IP</th>
                            <th><i class="fas fa-bullseye"></i> Destination</th>
                            <th><i class="fas fa-server"></i> Load Balancer</th>
                            <th><i class="fas fa-clock"></i> Duration</th>
                            <th><i class="fas fa-exchange-alt"></i> Traffic</th>
                            <th><i class="fas fa-info-circle"></i> Status</th>
                            <th><i class="fas fa-cogs"></i> Actions</th>
                        </tr>
                    </thead>
                    <tbody id="connectionsBody">
                        {{range .ActiveConnections}}
                        <tr class="connection-row" data-source="{{.SourceIP}}" data-dest="{{.DestinationIP}}">
                            <td class="source-cell">
                                <span class="ip clickable-ip" onclick="showSourceIPManagement('{{.SourceIP}}')">
                                    <i class="fas fa-mouse-pointer"></i>
                                    {{.SourceIP}}
                                </span>
                                <span class="port">:{{.SourcePort}}</span>
                            </td>
                            <td class="dest-cell">
                                <span class="ip">{{.DestinationIP}}</span>
                                <span class="port">:{{.DestinationPort}}</span>
                            </td>
                            <td class="lb-cell">
                                <i class="fas fa-server"></i>
                                LB{{add .LBIndex 1}}
                            </td>
                            <td class="duration-cell">
                                <i class="fas fa-stopwatch"></i>
                                {{duration .StartTime}}
                            </td>
                            <td class="traffic-cell">
                                <div class="traffic-info">
                                    <span class="bytes-in">
                                        <i class="fas fa-arrow-down"></i>
                                        {{formatBytes .BytesIn}}
                                    </span>
                                    <span class="bytes-out">
                                        <i class="fas fa-arrow-up"></i>
                                        {{formatBytes .BytesOut}}
                                    </span>
                                </div>
                            </td>
                            <td class="status-cell">
                                <span class="status {{.Status}}">
                                    <i class="fas fa-circle"></i>
                                    {{.Status}}
                                </span>
                            </td>
                            <td class="actions-cell">
                                <button class="btn btn-small btn-primary" 
                                        onclick="showWeightModal('{{.SourceIP}}')">
                                    <i class="fas fa-weight-hanging"></i>
                                    Set Weight
                                </button>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
                {{else}}
                <div class="no-connections">
                    <i class="fas fa-info-circle"></i>
                    <p>No active connections</p>
                    <small>Start using the SOCKS proxy to see real-time connections here</small>
                </div>
                {{end}}
            </div>
        </div>

        <!-- Active Source IPs -->
        {{if .ActiveSources}}
        <div class="section">
            <h2><i class="fas fa-globe"></i> Active Source IPs</h2>
            <div class="sources-table">
                <table class="unifi-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-map-marker-alt"></i> Source IP</th>
                            <th><i class="fas fa-link"></i> Active Connections</th>
                            <th><i class="fas fa-server"></i> Assigned LB</th>
                            <th><i class="fas fa-weight-hanging"></i> Effective Ratio</th>
                            <th><i class="fas fa-cogs"></i> Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .ActiveSources}}
                        <tr>
                            <td>
                                <span class="ip clickable-ip" onclick="showSourceIPManagement('{{.SourceIP}}')">
                                    <i class="fas fa-mouse-pointer"></i>
                                    {{.SourceIP}}
                                </span>
                            </td>
                            <td>
                                <i class="fas fa-list-ol"></i>
                                {{.ActiveConnections}}
                            </td>
                            <td>
                                <i class="fas fa-server"></i>
                                {{.AssignedLB}}
                            </td>
                            <td>
                                <i class="fas fa-percentage"></i>
                                {{.EffectiveRatio}}
                            </td>
                            <td>
                                <button class="btn btn-primary" 
                                        onclick="showSourceIPManagement('{{.SourceIP}}')">
                                    <i class="fas fa-cogs"></i>
                                    Manage Rules
                                </button>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
        {{end}}

        <!-- Configuration -->
        <div class="section">
            <h2><i class="fas fa-cog"></i> Configuration</h2>
            <div class="config-grid">
                <div class="config-item">
                    <i class="fas fa-tag"></i>
                    <div class="config-content">
                        <strong>Version</strong>
                        <span>{{.SystemInfo.Version}}</span>
                    </div>
                </div>
                <div class="config-item">
                    <i class="fas fa-file"></i>
                    <div class="config-content">
                        <strong>Config File</strong>
                        <span>{{.SystemInfo.ConfigFile}}</span>
                    </div>
                </div>
                <div class="config-item">
                    <i class="fas fa-network-wired"></i>
                    <div class="config-content">
                        <strong>Listen Address</strong>
                        <span>{{.SystemInfo.ListenAddress}}</span>
                    </div>
                </div>
                <div class="config-item">
                    <i class="fas fa-calendar-alt"></i>
                    <div class="config-content">
                        <strong>Started</strong>
                        <span>{{.SystemInfo.StartTime.Format "2006-01-02 15:04:05"}}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Rule Modal -->
    <div id="addRuleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addRuleModal')">&times;</span>
            <h3>Add Source IP Rule</h3>
            <form id="addRuleForm">
                <input type="hidden" id="modalLBAddress" name="lb_address">
                <div class="form-group">
                    <label for="sourceIP">Source IP/CIDR:</label>
                    <input type="text" id="sourceIP" name="source_ip" required 
                           placeholder="192.168.1.100 or 10.0.0.0/24">
                </div>
                <div class="form-group">
                    <label for="contentionRatio">Contention Ratio:</label>
                    <input type="number" id="contentionRatio" name="contention_ratio" 
                           min="1" max="100" value="1" required>
                    <small>Higher values = more priority for this source IP</small>
                </div>
                <div class="form-group">
                    <label for="description">Description:</label>
                    <input type="text" id="description" name="description" 
                           placeholder="e.g., High priority client">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addRuleModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Rule</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Set Weight Modal -->
    <div id="weightModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('weightModal')">&times;</span>
            <h3>Manage Load Balancing for Source IP</h3>
            <form id="weightForm">
                <input type="hidden" id="weightSourceIP" name="source_ip">
                <div class="form-group">
                    <label>Source IP:</label>
                    <span id="weightSourceIPDisplay" class="readonly-field"></span>
                </div>
                <div class="form-group">
                    <label for="weightLBSelect">Target Load Balancer:</label>
                    <select id="weightLBSelect" name="lb_address" required>
                        {{range .LoadBalancers}}
                        <option value="{{.Address}}">LB{{.ID}}: {{.Address}} ({{.Interface}})</option>
                        {{end}}
                    </select>
                </div>
                <div class="form-group">
                    <label for="weightRatio">Contention Ratio:</label>
                    <input type="number" id="weightRatio" name="contention_ratio" 
                           min="1" max="100" value="1" required>
                    <small>Higher values = more priority for this source IP on selected LB</small>
                </div>
                <div class="form-group">
                    <label for="weightDescription">Description:</label>
                    <input type="text" id="weightDescription" name="description" 
                           placeholder="e.g., VIP client high priority">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('weightModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Set Weight</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Rule Modal -->
    <div id="addRuleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addRuleModal')">&times;</span>
            <h3><i class="fas fa-plus"></i> Add Source IP Rule</h3>
            <form id="addRuleForm">
                <input type="hidden" id="modalLBAddress" name="lb_address">
                <div class="form-group">
                    <label for="sourceIP"><i class="fas fa-map-marker-alt"></i> Source IP/CIDR:</label>
                    <input type="text" id="sourceIP" name="source_ip" required 
                           placeholder="192.168.1.100 or 10.0.0.0/24">
                </div>
                <div class="form-group">
                    <label for="contentionRatio"><i class="fas fa-weight-hanging"></i> Contention Ratio:</label>
                    <input type="number" id="contentionRatio" name="contention_ratio" 
                           min="1" max="100" value="1" required>
                    <small>Higher values = more priority for this source IP</small>
                </div>
                <div class="form-group">
                    <label for="description"><i class="fas fa-comment"></i> Description:</label>
                    <input type="text" id="description" name="description" 
                           placeholder="e.g., High priority client">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('addRuleModal')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> Add Rule
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Set Weight Modal -->
    <div id="weightModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('weightModal')">&times;</span>
            <h3><i class="fas fa-weight-hanging"></i> Manage Load Balancing for Source IP</h3>
            <form id="weightForm">
                <input type="hidden" id="weightSourceIP" name="source_ip">
                <div class="form-group">
                    <label><i class="fas fa-map-marker-alt"></i> Source IP:</label>
                    <span id="weightSourceIPDisplay" class="readonly-field"></span>
                </div>
                <div class="form-group">
                    <label for="weightLBSelect"><i class="fas fa-server"></i> Target Load Balancer:</label>
                    <select id="weightLBSelect" name="lb_address" required>
                        {{range .LoadBalancers}}
                        <option value="{{.Address}}">LB{{.ID}}: {{.Address}} ({{.Interface}})</option>
                        {{end}}
                    </select>
                </div>
                <div class="form-group">
                    <label for="weightRatio"><i class="fas fa-weight-hanging"></i> Contention Ratio:</label>
                    <input type="number" id="weightRatio" name="contention_ratio" 
                           min="1" max="100" value="1" required>
                    <small>Higher values = more priority for this source IP on selected LB</small>
                </div>
                <div class="form-group">
                    <label for="weightDescription"><i class="fas fa-comment"></i> Description:</label>
                    <input type="text" id="weightDescription" name="description" 
                           placeholder="e.g., VIP client high priority">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('weightModal')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> Set Weight
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Source IP Management Modal -->
    <div id="sourceIPModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('sourceIPModal')">&times;</span>
            <h3><i class="fas fa-cogs"></i> Manage Load Balancing Rules</h3>
            <div id="sourceIPModalContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>

    <script src="/static/js/main.js"></script>
    <script src="/static/js/dashboard.js"></script>
    <script>
        // Auto-refresh every 5 seconds
        setInterval(function() {
            refreshDashboard();
        }, 5000);
        
        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loaded with UniFi theme');
        });
    </script>
</body>
</html> 