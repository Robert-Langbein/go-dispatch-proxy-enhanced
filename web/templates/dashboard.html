<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go Dispatch Proxy Enhanced - Dashboard</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h1>üöÄ Go Dispatch Proxy Enhanced</h1>
        </div>
        <div class="nav-controls">
            <span class="status {{if gt .SystemInfo.TotalLBs 0}}online{{else}}offline{{end}}">
                {{if gt .SystemInfo.TotalLBs 0}}‚óè Online{{else}}‚óè Offline{{end}}
            </span>
            <a href="/logout" class="btn btn-secondary">Logout</a>
        </div>
    </nav>

    <div class="container">
        <!-- System Overview -->
        <div class="section">
            <h2>üìä System Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">{{.SystemInfo.TotalLBs}}</div>
                    <div class="stat-label">Load Balancers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{.TotalConnections}}</div>
                    <div class="stat-label">Total Connections</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{printf "%.1f%%" .OverallSuccessRate}}</div>
                    <div class="stat-label">Success Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{.SystemInfo.Uptime}}</div>
                    <div class="stat-label">Uptime</div>
                </div>
            </div>
        </div>

        <!-- Load Balancers -->
        <div class="section">
            <h2>‚öñÔ∏è Load Balancers</h2>
            <div class="lb-grid">
                {{range .LoadBalancers}}
                <div class="lb-card {{if .Enabled}}enabled{{else}}disabled{{end}}">
                    <div class="lb-header">
                        <h3>LB {{.ID}}: {{.Address}}</h3>
                        <label class="toggle">
                            <input type="checkbox" {{if .Enabled}}checked{{end}} 
                                   onchange="toggleLoadBalancer('{{.Address}}', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="lb-info">
                        <p><strong>Interface:</strong> {{.Interface}}</p>
                        <p><strong>Default Ratio:</strong> {{.DefaultRatio}}</p>
                        <p><strong>Success Rate:</strong> {{printf "%.1f%%" .SuccessRate}}</p>
                    </div>
                    <div class="lb-stats">
                        <div class="stat-row">
                            <span>Total: {{.TotalConnections}}</span>
                            <span class="success">Successes: {{.SuccessCount}}</span>
                            <span class="error">Failures: {{.FailureCount}}</span>
                        </div>
                    </div>
                    {{if .SourceIPRules}}
                    <div class="source-rules">
                        <h4>Source IP Rules ({{len .SourceIPRules}})</h4>
                        {{range $ip, $rule := .SourceIPRules}}
                        <div class="rule-item">
                            <span class="source-ip">{{$ip}}</span>
                            <span class="ratio">Ratio: {{$rule.ContentionRatio}}</span>
                            <button class="btn btn-small btn-danger" 
                                    onclick="removeRule('{{$.Address}}', '{{$ip}}')">Remove</button>
                        </div>
                        {{end}}
                    </div>
                    {{end}}
                    <div class="add-rule">
                        <button class="btn btn-small btn-primary" 
                                onclick="showAddRuleModal('{{.Address}}')">Add Source IP Rule</button>
                    </div>
                </div>
                {{end}}
            </div>
        </div>

        <!-- Real-time Traffic Statistics -->
        <div class="section">
            <h2>üìä Real-time Traffic</h2>
            <div class="traffic-stats">
                <div class="traffic-grid">
                    <div class="traffic-card">
                        <div class="traffic-value" id="bytesPerSecond">{{formatBytes .TrafficStats.BytesPerSecond}}/s</div>
                        <div class="traffic-label">Transfer Rate</div>
                    </div>
                    <div class="traffic-card">
                        <div class="traffic-value" id="totalDataTransferred">{{formatBytes .TrafficStats.TotalDataTransferred}}</div>
                        <div class="traffic-label">Total Data</div>
                    </div>
                    <div class="traffic-card">
                        <div class="traffic-value" id="activeConnections">{{.TrafficStats.ActiveConnections}}</div>
                        <div class="traffic-label">Active Connections</div>
                    </div>
                    <div class="traffic-card">
                        <div class="traffic-value" id="connectionsPerMinute">{{.TrafficStats.ConnectionsPerMinute}}</div>
                        <div class="traffic-label">Connections/min</div>
                    </div>
                </div>
                
                <!-- Traffic Bars for Load Balancers -->
                <div class="traffic-bars">
                    <h3>Load Balancer Traffic Distribution</h3>
                    {{range $index, $lb := .LoadBalancers}}
                    <div class="lb-traffic-bar">
                        <div class="lb-traffic-label">LB{{add $index 1}}: {{$lb.Address}}</div>
                        <div class="traffic-bar-container">
                            <div class="traffic-bar" data-lb="{{$index}}" style="width: {{percentage $lb.TotalConnections $.TotalConnections}}%">
                                <span class="traffic-bar-text">{{$lb.TotalConnections}} connections ({{printf "%.1f%%" (percentage $lb.TotalConnections $.TotalConnections)}})</span>
                            </div>
                        </div>
                    </div>
                    {{end}}
                </div>
            </div>
        </div>

        <!-- Active Connections -->
        <div class="section">
            <h2>üîó Active Connections</h2>
            <div class="connections-controls">
                <input type="text" id="sourceFilter" placeholder="Filter by source IP..." onkeyup="filterConnections()">
                <input type="text" id="destFilter" placeholder="Filter by destination..." onkeyup="filterConnections()">
                <button class="btn btn-small btn-primary" onclick="refreshConnections()">Refresh</button>
                <span class="connection-count">Showing: <span id="connectionCount">{{len .ActiveConnections}}</span> connections</span>
            </div>
            
            <div class="connections-table" id="connectionsTable">
                {{if .ActiveConnections}}
                <table>
                    <thead>
                        <tr>
                            <th>Source IP</th>
                            <th>Destination</th>
                            <th>Load Balancer</th>
                            <th>Duration</th>
                            <th>Traffic</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="connectionsBody">
                        {{range .ActiveConnections}}
                        <tr class="connection-row" data-source="{{.SourceIP}}" data-dest="{{.DestinationIP}}">
                            <td class="source-cell">
                                <span class="ip clickable-ip" onclick="showSourceIPManagement('{{.SourceIP}}')">{{.SourceIP}}</span>
                                <span class="port">:{{.SourcePort}}</span>
                            </td>
                            <td class="dest-cell">
                                <span class="ip">{{.DestinationIP}}</span>
                                <span class="port">:{{.DestinationPort}}</span>
                            </td>
                            <td class="lb-cell">LB{{add .LBIndex 1}}</td>
                            <td class="duration-cell">{{duration .StartTime}}</td>
                            <td class="traffic-cell">
                                <div class="traffic-info">
                                    <span class="bytes-in">‚Üì{{formatBytes .BytesIn}}</span>
                                    <span class="bytes-out">‚Üë{{formatBytes .BytesOut}}</span>
                                </div>
                            </td>
                            <td class="status-cell">
                                <span class="status {{.Status}}">{{.Status}}</span>
                            </td>
                            <td class="actions-cell">
                                <button class="btn btn-small btn-primary" 
                                        onclick="showWeightModal('{{.SourceIP}}')">
                                    Set Weight
                                </button>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
                {{else}}
                <div class="no-connections">
                    <p>No active connections</p>
                    <small>Start using the SOCKS proxy to see real-time connections here</small>
                </div>
                {{end}}
            </div>
        </div>

        <!-- Active Source IPs -->
        {{if .ActiveSources}}
        <div class="section">
            <h2>üåê Active Source IPs</h2>
            <div class="sources-table">
                <table>
                    <thead>
                        <tr>
                            <th>Source IP</th>
                            <th>Active Connections</th>
                            <th>Assigned LB</th>
                            <th>Effective Ratio</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .ActiveSources}}
                        <tr>
                            <td>
                                <span class="ip clickable-ip" onclick="showSourceIPManagement('{{.SourceIP}}')">{{.SourceIP}}</span>
                            </td>
                            <td>{{.ActiveConnections}}</td>
                            <td>{{.AssignedLB}}</td>
                            <td>{{.EffectiveRatio}}</td>
                            <td>
                                <button class="btn btn-small btn-primary" 
                                        onclick="showSourceIPManagement('{{.SourceIP}}')">
                                    Manage Rules
                                </button>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
        {{end}}

        <!-- Configuration -->
        <div class="section">
            <h2>‚öôÔ∏è Configuration</h2>
            <div class="config-info">
                <p><strong>Version:</strong> {{.SystemInfo.Version}}</p>
                <p><strong>Config File:</strong> {{.SystemInfo.ConfigFile}}</p>
                <p><strong>Listen Address:</strong> {{.SystemInfo.ListenAddress}}</p>
                <p><strong>Started:</strong> {{.SystemInfo.StartTime.Format "2006-01-02 15:04:05"}}</p>
            </div>
        </div>
    </div>

    <!-- Add Rule Modal -->
    <div id="addRuleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addRuleModal')">&times;</span>
            <h3>Add Source IP Rule</h3>
            <form id="addRuleForm">
                <input type="hidden" id="modalLBAddress" name="lb_address">
                <div class="form-group">
                    <label for="sourceIP">Source IP/CIDR:</label>
                    <input type="text" id="sourceIP" name="source_ip" required 
                           placeholder="192.168.1.100 or 10.0.0.0/24">
                </div>
                <div class="form-group">
                    <label for="contentionRatio">Contention Ratio:</label>
                    <input type="number" id="contentionRatio" name="contention_ratio" 
                           min="1" max="100" value="1" required>
                    <small>Higher values = more priority for this source IP</small>
                </div>
                <div class="form-group">
                    <label for="description">Description:</label>
                    <input type="text" id="description" name="description" 
                           placeholder="e.g., High priority client">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addRuleModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Rule</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Set Weight Modal -->
    <div id="weightModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('weightModal')">&times;</span>
            <h3>Manage Load Balancing for Source IP</h3>
            <form id="weightForm">
                <input type="hidden" id="weightSourceIP" name="source_ip">
                <div class="form-group">
                    <label>Source IP:</label>
                    <span id="weightSourceIPDisplay" class="readonly-field"></span>
                </div>
                <div class="form-group">
                    <label for="weightLBSelect">Target Load Balancer:</label>
                    <select id="weightLBSelect" name="lb_address" required>
                        {{range .LoadBalancers}}
                        <option value="{{.Address}}">LB{{.ID}}: {{.Address}} ({{.Interface}})</option>
                        {{end}}
                    </select>
                </div>
                <div class="form-group">
                    <label for="weightRatio">Contention Ratio:</label>
                    <input type="number" id="weightRatio" name="contention_ratio" 
                           min="1" max="100" value="1" required>
                    <small>Higher values = more priority for this source IP on selected LB</small>
                </div>
                <div class="form-group">
                    <label for="weightDescription">Description:</label>
                    <input type="text" id="weightDescription" name="description" 
                           placeholder="e.g., VIP client high priority">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('weightModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Set Weight</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Source IP Management Modal -->
    <div id="sourceIPModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('sourceIPModal')">&times;</span>
            <h3>Manage Load Balancing Rules</h3>
            <div id="sourceIPModalContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>

    <script src="/static/js/main.js"></script>
    <script src="/static/js/dashboard.js"></script>
    <script>
        // Auto-refresh every 5 seconds
        setInterval(function() {
            refreshDashboard();
        }, 5000);
        
        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loaded');
        });
    </script>
</body>
</html> 